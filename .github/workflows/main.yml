name: Build Windows Application

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Cache PyInstaller build
      uses: actions/cache@v3
      with:
        path: |
          build
          __pycache__
          **/__pycache__
        key: ${{ runner.os }}-pyinstaller-${{ hashFiles('**/*.py') }}
        restore-keys: |
          ${{ runner.os }}-pyinstaller-
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify dependencies
      run: |
        python -c "import PyQt6; print(f'PyQt6 version: {PyQt6.QtCore.PYQT_VERSION_STR}')"
        python -c "import PyInstaller; print(f'PyInstaller version: {PyInstaller.__version__}')"
        pip list
        
    - name: Get version info
      id: version
      run: |
        $version = python -c "from core.app_info import __version__; print(__version__)"
        $app_name = python -c "from core.app_info import __app_name__; print(__app_name__)"
        $author = python -c "from core.app_info import __author__; print(__author__)"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "app_name=$app_name" >> $env:GITHUB_OUTPUT
        echo "author=$author" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
        echo "App Name: $app_name"
        echo "Author: $author"
      shell: powershell
      
    - name: Check required files
      run: |
        echo "Checking required files..."
        if (!(Test-Path "main.py")) { 
          Write-Error "main.py not found"
          exit 1 
        }
        if (!(Test-Path "core/app_info.py")) { 
          Write-Error "core/app_info.py not found"
          exit 1 
        }
        if (!(Test-Path "requirements.txt")) { 
          Write-Error "requirements.txt not found"
          exit 1 
        }
        if (!(Test-Path "build.py")) { 
          Write-Error "build.py not found"
          exit 1 
        }
        if (Test-Path "assets/icon.ico") { 
          echo "âœ“ Icon file found"
        } else { 
          echo "âš  Icon file not found, will use default"
        }
        if (Test-Path "assets/presets") { 
          $presets = (Get-ChildItem "assets/presets" -Filter "*.png" -ErrorAction SilentlyContinue).Count
          if ($presets -gt 0) {
            echo "âœ“ Found $presets preset images"
          } else {
            echo "âš  No preset images found"
          }
        } else { 
          echo "âš  Presets directory not found"
        }
        if (Test-Path "create_version_file.py") { 
          echo "âœ“ Version file generator found"
        } else { 
          echo "âš  create_version_file.py not found"
        }
      shell: powershell
      
    - name: Build application
      run: |
        echo "Starting build process..."
        echo "Working directory: $(Get-Location)"
        echo "Python version: $(python --version)"
        python build.py
      shell: powershell
      
    - name: Verify build output and find zip file
      id: build_output
      run: |
        $app_name = "${{ steps.version.outputs.app_name }}"
        $version = "${{ steps.version.outputs.version }}"
        $exe_path = "dist/$app_name/$app_name.exe"
        $expected_zip = "dist/${app_name}_v${version}.zip"
        
        # éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        if (Test-Path $exe_path) {
          $size = (Get-Item $exe_path).Length / 1MB
          echo "âœ“ Executable built successfully: $exe_path"
          echo "âœ“ Executable size: $([math]::Round($size, 2)) MB"
          
          # æ£€æŸ¥å…³é”®ç›®å½•ç»“æ„
          $internal_path = "dist/$app_name/_internal"
          if (Test-Path $internal_path) {
            echo "âœ“ _internal directory exists"
            if (Test-Path "$internal_path/assets/presets") {
              $preset_count = (Get-ChildItem "$internal_path/assets/presets" -Filter "*.png" -ErrorAction SilentlyContinue).Count
              echo "âœ“ Presets copied: $preset_count files"
            }
          }
          
          # éªŒè¯å¿…è¦ç›®å½•
          if (Test-Path "dist/$app_name/images/custom") {
            echo "âœ“ Custom images directory created"
          }
          if (Test-Path "dist/$app_name/backup") {
            echo "âœ“ Backup directory created"
          }
          
        } else {
          Write-Error "Build failed: executable not found at $exe_path"
          # æ˜¾ç¤ºå®é™…çš„ç›®å½•å†…å®¹ç”¨äºè°ƒè¯•
          if (Test-Path "dist") {
            echo "Actual dist contents:"
            Get-ChildItem "dist" -Recurse | Format-Table Name, Length, FullName
          }
          exit 1
        }
        
        # éªŒè¯æ„å»ºè„šæœ¬ç”Ÿæˆçš„ zip æ–‡ä»¶
        if (Test-Path $expected_zip) {
          $zip_size = (Get-Item $expected_zip).Length / 1MB
          echo "âœ“ Release zip created by build script: $expected_zip"
          echo "âœ“ Zip size: $([math]::Round($zip_size, 2)) MB"
          echo "zip_path=$expected_zip" >> $env:GITHUB_OUTPUT
          echo "zip_name=${app_name}_v${version}" >> $env:GITHUB_OUTPUT
        } else {
          # æŸ¥æ‰¾æ˜¯å¦æœ‰å…¶ä»– zip æ–‡ä»¶
          $zip_files = Get-ChildItem "dist" -Filter "*.zip" -ErrorAction SilentlyContinue
          if ($zip_files.Count -gt 0) {
            echo "Found zip files:"
            foreach ($zip in $zip_files) {
              $zip_size = $zip.Length / 1MB
              echo "  - $($zip.Name) ($([math]::Round($zip_size, 2)) MB)"
            }
            # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª zip æ–‡ä»¶
            $actual_zip = $zip_files[0].FullName
            echo "zip_path=$actual_zip" >> $env:GITHUB_OUTPUT
            echo "zip_name=$($zip_files[0].BaseName)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "No zip file found. Expected: $expected_zip"
            echo "dist directory contents:"
            Get-ChildItem "dist" | Format-Table Name, Length
            exit 1
          }
        }
      shell: powershell
      
    - name: Test executable (basic check)
      run: |
        $app_name = "${{ steps.version.outputs.app_name }}"
        $exe_path = "dist/$app_name/$app_name.exe"
        
        try {
          $fileInfo = Get-Item $exe_path
          echo "âœ“ File exists and accessible"
          echo "  Created: $($fileInfo.CreationTime)"
          echo "  Modified: $($fileInfo.LastWriteTime)"
          echo "  Size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å¯æ‰§è¡Œæ–‡ä»¶
          $fileHeader = Get-Content $exe_path -Encoding Byte -TotalCount 2
          if ($fileHeader[0] -eq 77 -and $fileHeader[1] -eq 90) {
            echo "âœ“ Valid PE executable format"
          } else {
            Write-Warning "File may not be a valid executable"
          }
        } catch {
        Write-Error "Failed to access executable: $_"
          exit 1
        }
      shell: powershell
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.build_output.outputs.zip_name }}
        path: ${{ steps.build_output.outputs.zip_path }}
        retention-days: 30
        
    - name: Upload application directory (for debugging)
      uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.version.outputs.app_name }}_debug
        path: dist/${{ steps.version.outputs.app_name }}/
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          *.spec
          build/
          *.log
        retention-days: 7
        
    # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œåˆ›å»º GitHub Pre-release
    - name: Create Pre-release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build_output.outputs.zip_path }}
        name: ${{ steps.version.outputs.app_name }} v${{ steps.version.outputs.version }} (Pre-release)
        tag_name: ${{ github.ref_name }}
        prerelease: true
        draft: false
        body: |
          ## ğŸš€ é¢„å‘å¸ƒç‰ˆæœ¬ v${{ steps.version.outputs.version }}
          
          > âš ï¸ **è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼Œè¯·è°¨æ…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚**
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **åº”ç”¨åç§°**: ${{ steps.version.outputs.app_name }}
          - **ç‰ˆæœ¬**: v${{ steps.version.outputs.version }}
          - **ä½œè€…**: ${{ steps.version.outputs.author }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
          - **æ„å»ºç¯å¢ƒ**: Windows (GitHub Actions)
          
          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½é™„ä»¶ä¸­çš„ `${{ steps.build_output.outputs.zip_name }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•ï¼ˆå»ºè®®è§£å‹åˆ°ä¸åŒ…å«ä¸­æ–‡å’Œç©ºæ ¼çš„è·¯å¾„ï¼‰
          3. è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹
          4. åŒå‡»è¿è¡Œ `${{ steps.version.outputs.app_name }}.exe`
          
          ### ğŸ’» ç³»ç»Ÿè¦æ±‚
          - **æ“ä½œç³»ç»Ÿ**: Windows 10/11 (x64)
          - **æ¶æ„**: 64ä½ç³»ç»Ÿ
          - **æƒé™**: æ— éœ€ç®¡ç†å‘˜æƒé™
          - **ä¾èµ–**: æ— éœ€é¢å¤–å®‰è£… Python æˆ–å…¶ä»–è¿è¡Œæ—¶
          
          ### ğŸ“‚ æ–‡ä»¶è¯´æ˜
          
